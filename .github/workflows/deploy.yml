name: ðŸš€ Deploy Backend to App Servers

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, pdo, bcmath, zip, curl, intl, gd, xml
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
            node-version: '20'
      - name: Install and build frontend
        run: |
          npm ci
          npm run build
          tar -czf build.tar.gz public
      # Deploy to Server 1
      - name: Deploy to Server 1
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP_1 }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY_1 }}
          source: "build.tar.gz"
          target: "/tmp"

      - name: Upload build to Server 2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP_2 }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY_2 }}
          source: "build.tar.gz"
          target: "/tmp"


      - name: Run Deploy to Server 1
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP_1 }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY_1 }}
          script: |
            echo "ðŸš€ Deploying to Server 1..."
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts

            if [ ! -d /var/www/app/.git ]; then
              sudo mkdir -p /var/www/app
              sudo chown -R $USER:$USER /var/www/app
              git clone git@github.com:QuvonchbekJalilov/Inter-AI-Job.git /var/www/app
            else
              cd /var/www/app
              git reset --hard
              git pull origin main
            fi

            cd /var/www/app

            tar -xzf /tmp/build.tar.gz -C /var/www/app
            composer install --no-interaction --prefer-dist --optimize-autoloader
            php artisan migrate --force
            
            php artisan optimize:clear
            npm install 
            npm run build
            sudo systemctl restart php8.3-fpm
            sudo systemctl restart nginx

            echo "âœ… Server 1 deployment completed."

      # Deploy to Server 2
      - name: Deploy to Server 2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP_2 }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY_2 }}
          script: |
            echo "ðŸš€ Deploying to Server 2..."
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            git config --global --add safe.directory /var/www/app

            if [ ! -d /var/www/app/.git ]; then
              sudo mkdir -p /var/www/app
              sudo chown -R $USER:$USER /var/www/app
              git clone git@github.com:QuvonchbekJalilov/Inter-AI-Job.git /var/www/app
            else
              cd /var/www/app
              git reset --hard
              git pull origin main
            fi

            cd /var/www/app
            tar -xzf /tmp/build.tar.gz -C /var/www/app
            composer install --no-interaction --prefer-dist --optimize-autoloader
            php artisan migrate --force
            php artisan optimize:clear
            npm install 
            npm run build
            sudo systemctl restart php8.3-fpm
            sudo systemctl restart nginx
            echo "âœ… Server 2 deployment completed."

# name: Deploy Backend to App Servers

# on:
#   push:
#     branches:
#       - main   

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout repo
#       uses: actions/checkout@v3

#     - name: Setup PHP
#       uses: shivammathur/setup-php@v2
#       with:
#         php-version: '8.4'


#     # ðŸš€ Deploy to App Server 1
#     - name: Deploy to App Server 1
#       uses: appleboy/ssh-action@v1.0.0
#       with:
#         host: ${{ secrets.SERVER_IP_1 }}
#         username: ${{ secrets.SERVER_USER }}
#         key: ${{ secrets.SERVER_SSH_KEY_1 }}
#         script: |
#           mkdir -p ~/.ssh
#           ssh-keyscan github.com >> ~/.ssh/known_hosts

#           if [ ! -d /var/www/app/.git ]; then
#             sudo mkdir -p /var/www/app
#             sudo chown -R $USER:$USER /var/www/app
#             git clone git@github.com:QuvonchbekJalilov/Inter-AI-Job.git /var/www/app
#           else
#             cd /var/www/app
#             git pull origin main
#           fi

#           cd /var/www/app
#           # cp .env.test .env   
#           composer install --no-interaction --prefer-dist --optimize-autoloader
#           php artisan migrate --force
#           php artisan config:clear
#           php artisan cache:clear
#           php artisan config:cache
#           php artisan route:cache
#           sudo systemctl restart php8.3-fpm
#           sudo systemctl restart nginx

#     - name: Deploy to App Server 2
#       uses: appleboy/ssh-action@v1.0.0
#       with:
#             host: ${{ secrets.SERVER_IP_2 }}
#             username: ${{ secrets.SERVER_USER }}
#             key: ${{ secrets.SERVER_SSH_KEY_2 }}
#             script: |
#               echo "âœ… Connected!"

#               mkdir -p ~/.ssh
#               ssh-keyscan github.com >> ~/.ssh/known_hosts

#               echo "${{ secrets.SERVER_SSH_KEY_2 }}" > ~/.ssh/id_rsa
#               chmod 600 ~/.ssh/id_rsa
#               if [ ! -d /var/www/app/.git ]; then
#                 sudo mkdir -p /var/www/app
#                 sudo chown -R $USER:$USER /var/www/app
#                 GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -o IdentitiesOnly=yes" git clone git@github.com:QuvonchbekJalilov/Inter-AI-Job.git /var/www/app
#               else
#                 cd /var/www/app
#                 GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -o IdentitiesOnly=yes" git pull origin main
#               fi

#               cd /var/www/app
#               # cp .env.test .env   
#               composer install --no-interaction --prefer-dist --optimize-autoloader
#               php artisan migrate --force
#               php artisan config:clear
#               php artisan cache:clear
#               php artisan config:cache
#               php artisan route:cache
#               sudo systemctl restart php8.3-fpm
#               sudo systemctl restart nginx

    # ðŸš€ Deploy to App Server 2
    # - name: Deploy to App Server 2
    #   uses: appleboy/ssh-action@v1.0.0
    #   with:
    #     host: ${{ secrets.SERVER_IP_2 }}
    #     username: ${{ secrets.SERVER_USER }}
    #     key: ${{ secrets.SERVER_SSH_KEY_2 }}
    #     script: |
    #       if [ ! -d /var/www/app ]; then
    #         sudo mkdir -p /var/www/app
    #         sudo chown -R $USER:$USER /var/www/app
    #         git clone https://github.com/QuvonchbekJalilov/Inter-AI-Job.git /var/www/app
    #       fi
    #       cd /var/www/app
    #       git pull origin main
    #       cp .env.test .env     # âœ… .env.test â†’ .env
    #       composer install --no-interaction --prefer-dist --optimize-autoloader
    #       php artisan config:cache
    #       php artisan route:cache
    #       sudo systemctl restart php8.4-fpm
    #       sudo systemctl restart nginx
