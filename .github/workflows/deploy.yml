name: Deploy Backend to App Servers

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        server: 
          - { ip: "${{ secrets.SERVER_IP_1 }}", key: "${{ secrets.SERVER_SSH_KEY_1 }}" }
          - { ip: "${{ secrets.SERVER_IP_2 }}", key: "${{ secrets.SERVER_SSH_KEY_2 }}" }

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Deploy to App Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ matrix.server.ip }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ matrix.server.key }}
        script_stop: true
        script: |
          echo "ðŸš€ Starting deployment on $(hostname)"

          # 1. Prepare SSH for GitHub
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git config --global --add safe.directory /var/www/app

          # 2. Clone or Update Repository
          if [ ! -d /var/www/app/.git ]; then
            echo "ðŸ“‚ Fresh clone"
            sudo mkdir -p /var/www/app
            sudo chown -R $USER:$USER /var/www/app
            git clone git@github.com:QuvonchbekJalilov/Inter-AI-Job.git /var/www/app
          else
            echo "ðŸ“‚ Updating existing repo"
            cd /var/www/app
            git reset --hard
            git clean -fd
            git pull origin main
          fi

          cd /var/www/app

          # 3. Install required PHP extensions (only once per server)
          echo "ðŸ“¦ Installing PHP dependencies"
          # sudo apt-get update -y
          # sudo apt-get install -y php8.3-zip php8.3-redis php8.3-mbstring php8.3-bcmath php8.3-intl php8.3-gd php8.3-xml unzip

          # 4. Laravel Dependencies
          echo "ðŸ“¦ Composer install"
          composer install --no-interaction --prefer-dist --optimize-autoloader

          # 5. Laravel Optimizations
          echo "âš¡ Running artisan commands"
          php artisan migrate --force
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
          php artisan route:cache

          # 6. Restart services
          echo "ðŸ”„ Restarting services"
          sudo systemctl restart php8.3-fpm
          sudo systemctl restart nginx

          echo "âœ… Deployment finished on $(hostname)"

# name: Deploy Backend to App Servers

# on:
#   push:
#     branches:
#       - main   

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout repo
#       uses: actions/checkout@v3

#     - name: Setup PHP
#       uses: shivammathur/setup-php@v2
#       with:
#         php-version: '8.4'


#     # ðŸš€ Deploy to App Server 1
#     - name: Deploy to App Server 1
#       uses: appleboy/ssh-action@v1.0.0
#       with:
#         host: ${{ secrets.SERVER_IP_1 }}
#         username: ${{ secrets.SERVER_USER }}
#         key: ${{ secrets.SERVER_SSH_KEY_1 }}
#         script: |
#           mkdir -p ~/.ssh
#           ssh-keyscan github.com >> ~/.ssh/known_hosts

#           if [ ! -d /var/www/app/.git ]; then
#             sudo mkdir -p /var/www/app
#             sudo chown -R $USER:$USER /var/www/app
#             git clone git@github.com:QuvonchbekJalilov/Inter-AI-Job.git /var/www/app
#           else
#             cd /var/www/app
#             git pull origin main
#           fi

#           cd /var/www/app
#           # cp .env.test .env   
#           composer install --no-interaction --prefer-dist --optimize-autoloader
#           php artisan migrate --force
#           php artisan config:clear
#           php artisan cache:clear
#           php artisan config:cache
#           php artisan route:cache
#           sudo systemctl restart php8.3-fpm
#           sudo systemctl restart nginx

#     - name: Deploy to App Server 2
#       uses: appleboy/ssh-action@v1.0.0
#       with:
#             host: ${{ secrets.SERVER_IP_2 }}
#             username: ${{ secrets.SERVER_USER }}
#             key: ${{ secrets.SERVER_SSH_KEY_2 }}
#             script: |
#               echo "âœ… Connected!"

#               mkdir -p ~/.ssh
#               ssh-keyscan github.com >> ~/.ssh/known_hosts

#               echo "${{ secrets.SERVER_SSH_KEY_2 }}" > ~/.ssh/id_rsa
#               chmod 600 ~/.ssh/id_rsa
#               if [ ! -d /var/www/app/.git ]; then
#                 sudo mkdir -p /var/www/app
#                 sudo chown -R $USER:$USER /var/www/app
#                 GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -o IdentitiesOnly=yes" git clone git@github.com:QuvonchbekJalilov/Inter-AI-Job.git /var/www/app
#               else
#                 cd /var/www/app
#                 GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -o IdentitiesOnly=yes" git pull origin main
#               fi

#               cd /var/www/app
#               # cp .env.test .env   
#               composer install --no-interaction --prefer-dist --optimize-autoloader
#               php artisan migrate --force
#               php artisan config:clear
#               php artisan cache:clear
#               php artisan config:cache
#               php artisan route:cache
#               sudo systemctl restart php8.3-fpm
#               sudo systemctl restart nginx

    # ðŸš€ Deploy to App Server 2
    # - name: Deploy to App Server 2
    #   uses: appleboy/ssh-action@v1.0.0
    #   with:
    #     host: ${{ secrets.SERVER_IP_2 }}
    #     username: ${{ secrets.SERVER_USER }}
    #     key: ${{ secrets.SERVER_SSH_KEY_2 }}
    #     script: |
    #       if [ ! -d /var/www/app ]; then
    #         sudo mkdir -p /var/www/app
    #         sudo chown -R $USER:$USER /var/www/app
    #         git clone https://github.com/QuvonchbekJalilov/Inter-AI-Job.git /var/www/app
    #       fi
    #       cd /var/www/app
    #       git pull origin main
    #       cp .env.test .env     # âœ… .env.test â†’ .env
    #       composer install --no-interaction --prefer-dist --optimize-autoloader
    #       php artisan config:cache
    #       php artisan route:cache
    #       sudo systemctl restart php8.4-fpm
    #       sudo systemctl restart nginx
