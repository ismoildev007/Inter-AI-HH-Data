name: Deploy Backend to App Servers

on:
  push:
    branches:
      - main   

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'

    # - name: Install dependencies (local check)
    #   run: |
    #     composer install --no-interaction --prefer-dist --optimize-autoloader
    #     php artisan config:clear
    #     php artisan cache:clear

    # ðŸš€ Deploy to App Server 1
    - name: Deploy to App Server 1
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_IP_1 }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY_1 }}
        script: |
          if [ ! -d /var/www/app/.git ]; then
            sudo mkdir -p /var/www/app
            sudo chown -R $USER:$USER /var/www/app
            git clone https://github.com/QuvonchbekJalilov/Inter-AI-Job.git /var/www/app
          else
            cd /var/www/app
            git pull origin main
          fi
          cd /var/www/app
          cp .env.test .env   # âœ… artisan ishlashidan oldin .env tayyor
          composer install --no-interaction --prefer-dist --optimize-autoloader
          php artisan migrate --force
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
          php artisan route:cache
          sudo systemctl restart php8.4-fpm
          sudo systemctl restart nginx


    # ðŸš€ Deploy to App Server 2
    # - name: Deploy to App Server 2
    #   uses: appleboy/ssh-action@v1.0.0
    #   with:
    #     host: ${{ secrets.SERVER_IP_2 }}
    #     username: ${{ secrets.SERVER_USER }}
    #     key: ${{ secrets.SERVER_SSH_KEY_2 }}
    #     script: |
    #       if [ ! -d /var/www/app ]; then
    #         sudo mkdir -p /var/www/app
    #         sudo chown -R $USER:$USER /var/www/app
    #         git clone https://github.com/QuvonchbekJalilov/Inter-AI-Job.git /var/www/app
    #       fi
    #       cd /var/www/app
    #       git pull origin main
    #       cp .env.test .env     # âœ… .env.test â†’ .env
    #       composer install --no-interaction --prefer-dist --optimize-autoloader
    #       php artisan config:cache
    #       php artisan route:cache
    #       sudo systemctl restart php8.4-fpm
    #       sudo systemctl restart nginx
